<script>
import ScrollToTop from './Elements/ScrollToUpBtn.vue';
import Navbar from './Elements/Navbar.vue';

import instance from '../../axios-infos.js'
import axios from 'axios';

export default {
    name: 'Home',
    components: {
        ScrollToTop, Navbar
    },
    props: {
        id: Number
    },
    data() {
        return {
            currentCollection: [],      // les infos de la collection courante
            currentComic: {},            // les infos du comics courant
            currentComicName: '',       // le nom du comics courant
            comic: [],                  // les infos du comics
            currentHouse: [],        // les infos de la maison d'édition
            linkImages: [],
            readMode: 'scroll',         // mode de lecture (scroll ou onePage)
            currentPage: 1,             // page courante
            linkCurrentPage: '',
            optionPageValue: 1,
            navbar: {
                isNavbarHidden: false,
                navbarState: 'expand_less',
            },
            isConnected: localStorage.getItem('isConnected'),
        }
    },
    methods: {
        redirect(routeName) {
            this.$router.push({ name: routeName });
        },
        // Récupération des liens des images du comics depuis la BDD liée à l'API
        async recupCollection() {
            // On sauvegarde les infos du comics actuel dans la variable currentComic
            this.currentComic = await JSON.parse(localStorage.getItem('currentComic'));

            // Requete GET pour récupérer le nom de la collection
            const URL = `${instance.baseURL}${this.currentComic.comicsCollection}`;
            axios.get(URL)
                .then(response => {
                    // On récupère les infos de la collection actuelle
                    this.currentCollection = response.data;

                    // On récupère les infos de la maison d'édition
                    this.currentHouse = this.currentCollection.house;

                    // On lance cette fonction pour récupérer les infos du comics actuel
                    this.recupCurrentComic();
                })
                .catch(error => {
                    console.log(error)
                })
        },
        // Récupération des infos du comics actuel en fonction de l'id contenu dans l'url
        recupCurrentComic() {
            let paramsID = this.$route.params.id;

            // Requete GET pour récupérer le comics actuel
            const URL = `${instance.baseURL}/api/comics/${paramsID}`;

            axios.get(URL)
                .then(response => {
                    // On récupère les infos du comics actuel
                    this.currentComic = response.data;

                    // convert name
                    this.currentComicName = this.currentComic.name.replaceAll('+', ' ');

                    console.log('CURRENT COMICS MOTHER FICKER', this.currentComic);

                    // On lance cette fonction pour récupérer les infos du comics actuel
                    this.recupComic();
                })
                .catch(error => {
                    console.log(error)
                })
        },
        // Récupération des liens des images du comics depuis la BDD liée à l'API
        recupComic() {

            let numero = 0;
            for (let i = 1; i < this.currentComic.nbPage + 1; i++) {
                if (i <= 9) {
                    numero = '00' + i.toString();
                    this.linkImages.push({ numero: numero, url: `${instance.AWS_URL}/${this.currentComic.name}/${numero}.${this.currentComic.extension}` });
                } else if (i > 9 && i <= 99) {
                    numero = '0' + i.toString();
                    this.linkImages.push({ numero: numero, url: `${instance.AWS_URL}/${this.currentComic.name}/${numero}.${this.currentComic.extension}` });
                } else {
                    numero = i.toString();
                    this.linkImages.push({ numero: numero, url: `${instance.AWS_URL}/${this.currentComic.name}/${numero}.${this.currentComic.extension}` });
                }
            }

        },
        changePage(value) {

            let numeroPage;

            if (value === 'next') {
                this.currentPage++;

                if (this.currentPage <= 9) {
                    numeroPage = '00' + this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                } else if (this.currentPage > 9 && this.currentPage <= 99) {
                    numeroPage = '0' + this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                } else {
                    numeroPage = this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                }
            } else if (value === 'back') {
                this.currentPage--;

                if (this.currentpage < 1) {
                    this.currentPage = 1;
                    document.querySelector('.arrow-back').disabled = true;
                } else if (this.currentPage <= 9) {
                    numeroPage = '00' + this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                } else if (this.currentPage > 9 && this.currentPage <= 99) {
                    numeroPage = '0' + this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                } else {
                    numeroPage = this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                }
            } else {
                this.currentPage = value;

                if (this.currentPage <= 9) {
                    numeroPage = '00' + this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                } else if (this.currentPage > 9 && this.currentPage <= 99) {
                    numeroPage = '0' + this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                } else {
                    numeroPage = this.currentPage.toString();
                    this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/${numeroPage}.${this.currentComic.extension}`;
                    console.log(this.linkCurrentPage);
                }
            }

        },
        hideNavbar() {
            this.navbar.isNavbarHidden = !this.navbar.isNavbarHidden;

            if (this.navbar.navbarState === 'expand_more') {
                this.navbar.navbarState = 'expand_less';
            } else {
                this.navbar.navbarState = 'expand_more';
            }

            // document.querySelector('.select-readMode').style.top = "-var(--navbar-height)";

        },
        ScrollEventListener() {
            var prevScrollpos = window.pageYOffset;

            window.addEventListener('scroll', function () {
                var currentScrollPos = window.pageYOffset;

                console.log('scroll', prevScrollpos, currentScrollPos);

                if (prevScrollpos > currentScrollPos) {
                    document.getElementById("navbar").style.top = "0px";
                    document.querySelector('.select-readMode').style.top = "var(--navbar-height)";
                } else {
                    document.getElementById("navbar").style.top = "-50px";
                    document.querySelector('.select-readMode').style.top = "-var(--navbar-height)";
                }

                prevScrollpos = currentScrollPos;
            });
        },
    },
    async mounted() {

        console.log(this.$route.params.id);

        // Récupération de la collection
        await this.recupCollection();

        this.linkCurrentPage = `${instance.AWS_URL}/${this.currentComic.name}/001.${this.currentComic.extension}`

        document.title = `Lecture - ${this.currentComic.name}`

        // On scroll en haut de la page (car spawn au milieu en arrivant sur la page)
        window.scrollTo({
            top: 0,
            behavior: "smooth"
        });



        // this.ScrollEventListener(); // Elle a arrete de fonctionner du jour au lendemain, je sais pas pourquoi
    }
}

</script>


<template>

    <div id="container">
        <div v-if="!navbar.isNavbarHidden" id="navbar">
            <Navbar />
        </div>

        <!-- On affiche le mode de lecture -->
        <div class="select-readMode" v-if="isConnected == 'true'">
            <!-- <label for="selectReadMode"> Mode de lecture : </label> -->
            <select name="selectReadMode" id="selectReadMode" v-model="this.readMode">
                <option value="scroll">Tout sur la même page</option>
                <option value="onePage">Page par Page</option>
            </select>

            <select name="selectPage" id="selectPage" v-if="this.readMode == 'onePage'" v-model="this.currentPage"
                @click="() => changePage(this.currentPage)">
                <option v-for="page in this.currentComic.nbPage" :value="page">
                    <i class="fa fa-arrows-h" aria-hidden="true"></i> Page {{ page }}
                </option>
            </select>
        </div>

        <!-- On affiche les infos du comics -->
        <div class="container-infos">

            <div class="left-right">
                <div class="left">
                    <img v-if="linkImages[0]" :src="linkImages[0].url" width="1000px">
                </div>
                <div class="right">
                    <div>
                        <h1> Informations </h1>
                        <h3> <b> {{ this.currentComicName }} </b> </h3>
                        <p> Collection : <b> {{ this.currentCollection.name }} </b> </p>
                        <p> Nombre de pages : <b> {{ this.currentComic.nbPage }} </b> </p>
                        <p v-if="this.currentHouse.name == 'MARVEL'">
                            Maison d'édition : <img id="house-logo-marvel" src="../assets/Marvel_Logo.svg"
                                title="MARVEL" alt="">
                        </p>
                        <p v-else-if="this.currentHouse.name == 'DC COMICS'">
                            Maison d'édition : <img id="house-logo-dc" src="../assets/DC_Comics_logo.png"
                                title="DC COMICS" alt="">
                        </p>
                    </div>
                </div>
            </div>

        </div>


        <h1> Bonne lecture 😀 </h1> <br>

        <!-- On affiche les images du comics -->
        <div v-if="isConnected == 'true'">
            <div v-if="this.readMode === 'scroll'">
                <div class="container-images-scroll">
                    <div class="images" v-for="image in linkImages">
                        <img v-if="image" :src="image.url" :alt="`Page ${image.numero} - ${this.currentComic.name}`"
                            :title="`Page ${image.numero} - ${this.currentComic.name}`">
                    </div>
                </div>
            </div>
            <div v-else>
                <div class="container-images-onePage">
                    <button v-if="currentPage > 1" type="button" class="arrow-back" @click="() => changePage('back')">
                        &lt
                    </button>
                    <button v-else type="button" class="arrow-back" disabled> &lt </button>
                    <img id="currentImg" :src="this.linkCurrentPage" @click="() => changePage('next')">
                    <button type="button" class="arrow-next" @click="() => changePage('next')"> > </button>
                </div>
            </div>
        </div>
        <div v-else>
            <div class="band-connect">
                <div class="band-connect-left">
                    <h2> Vous voulez lire ce comics ? </h2>
                    <button type="button" class="btn" @click="() => this.redirect('Login')" > 
                        Connectez-vous 
                    </button>
                </div>
                <img :src="this.linkCurrentPage" alt="">
            </div>
        </div>

        <button class="nbPage hideNavbar" type="button" @click="hideNavbar">
            <span class="textBtnHideNavbar" v-if="navbar.isNavbarHidden"> Afficher la navbar </span>
            <span class="material-symbols-outlined"> {{ navbar.navbarState }} </span>
        </button>

        
        <ScrollToTop />

    </div>

    

</template>


<style scoped >
#navbar {
    position: fixed;
    top: 0;
    width: 100%;
    display: block;
    transition: top 0.3s;
    z-index: 1000000000000;
}

h1 {
    text-align: center;
    font-size: 3em;
}

h2 {
    text-align: center;
}

.container-infos {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin-top: 120px;
}

.left-right {
    max-width: 1000px;
    margin-bottom: 100px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

.left {
    width: 100%;
    height: 100%;
}

.left img {
    width: 70%;
}

.left,
.right {
    display: block;
    justify-content: center;
    align-items: center;
    width: 50vw;
}

.right h1 {
    display: flex;
    justify-content: flex-start;
    padding-bottom: 20px;
    border-bottom: 5px solid var(--main-color);
    position: absolute;
    top: 0;
    width: 500px;
}

.right h3 {
    font-size: 2em;
}

.right p {
    font-size: 1.5em;
}

#house-logo-marvel {
    width: 75px;
    transform: translateY(5px);
}

#house-logo-dc {
    width: 50px;
    transform: translateY(10px);
}

.container-images-scroll img {
    max-width: 760px;
}

.container-images-onePage {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin-top: 220px;
}

.container-images-onePage button {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--secondary-color);
    color: white;
    font-size: 2em;
    border: none;
    margin-inline: 30px;
}

.container-images-onePage button:hover {
    cursor: pointer;
    transform: scale(1.1);
}

.container-images-onePage img {
    max-width: 760px;
}

.band-connect {
    display: flex;
    justify-content: center;
    align-items: center;

    margin: 50px auto;
    width: 80%;
    height: 400px;

    background: var(--main-color);
}

.band-connect h2 {
    font-size: 2em;
    color: var(--font-color);
    line-height: 40px;
}

.band-connect img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.band-connect-left {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 50%;
}

.select-readMode {
    position: fixed;
    left: 20px;
    top: var(--navbar-height);
    padding-top: 20px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
    z-index: 1;
}

.select-readMode p {
    margin: 0;
}

.images {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    flex-direction: column;
}



.hideNavbar {
    background: transparent;
    color: #000;
    border: none;
    cursor: pointer;
    position: fixed;
    top: 30px;
    right: 30px;
    z-index: 100000000000000000000;
}

.hideNavbar span {
    font-size: 3em;
}

.hideNavbar span.textBtnHideNavbar {
    font-size: 1.5em;
    position: fixed;
    top: 38px;
    right: 100px;
}

/* button disabled */
button:disabled {
    background-color: var(--transparent-color);
    color: var(--transparent-color);
    cursor: not-allowed;
}

button:disabled:hover {
    transform: scale(1);
    cursor: not-allowed;
}

.footer {
    bottom: 0;
    left: 0;
    width: 100%;
}

</style>